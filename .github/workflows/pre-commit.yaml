name: CI Checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Manual trigger

jobs:
  lint-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for git commit and push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get all history to allow git add/commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks (excluding sync)
        run: pre-commit run --all-files --hook-stage manual
        continue-on-error: true

      - name: Sync AI Documentation Files
        id: sync_docs
        run: |
          MASTER=".settings/master.md"
          RULES=".settings/rules.md"

          MASTER_TARGETS=(
              ".claude/claude.md"
              ".codex/agents.md"
              ".gemini/gemini.md"
              ".github/copilot-instructions.md"
          )

          RULES_TARGETS=(
              ".claude/rules/rules.md"
              ".codex/rules/rules.md"
              ".gemini/rules/rules.md"
          )

          changed=0

          sync_file() {
              local src="$1"
              local dst="$2"
              if ! cmp -s "$src" "$dst" 2>/dev/null; then
                  mkdir -p "$(dirname "$dst")" # Ensure directory exists
                  cp "$src" "$dst"
                  git add "$dst"
                  echo "synced: $src -> $dst"
                  changed=1
              fi
          }

          for dst in "${MASTER_TARGETS[@]}"; do
              sync_file "$MASTER" "$dst"
          done

          for dst in "${RULES_TARGETS[@]}"; do
              sync_file "$RULES" "$dst"
          done

          if [ "$changed" -eq 1 ]; then
              echo "Documentation files were synced. Creating a commit."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git commit -m "docs: Sync AI documentation files"
              git push
              echo "::set-output name=docs_synced::true"
          else
              echo "Documentation files are already up to date."
              echo "::set-output name=docs_synced::false"
          fi
        shell: bash

      - name: Notify on documentation sync
        if: steps.sync_docs.outputs.docs_synced == 'true'
        run: echo "Documentation files were synced and committed to the repository."
