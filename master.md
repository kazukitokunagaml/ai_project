# Project Context & AI Constitution (プロジェクト憲法)

このドキュメントは、本リポジトリで作業するすべての生成AIエージェント（Claude, Gemini, Copilot, Cursor等）が最初に読み込むべき「プロジェクトの憲法」である。すべてのAIはこの文書に記載された原則に従うこと。

---

## 1. 基本行動原理 (Core Principles)

### 1.1 外科的変更 (Surgical Changes)

- 修正が必要な箇所**のみ**を変更せよ
- 隣接する壊れていないコード、フォーマット、コメントを改善しようとするな
- 既存のコードスタイルが自分の好みと異なっていても、既存のスタイルに合わせよ
- 自身の変更で生じた未使用のインポートや変数は削除せよ。ただし、変更前から存在していたデッドコードには手を触れるな
- Git の diff を最小限かつ清潔に保つことを最優先せよ

### 1.2 単純性優先 (Simplicity First / YAGNI)

- 要求されていない抽象化、拡張性、設計パターンを導入するな
- 50行で書けるものを200行にするな
- 1回しか使われない処理のためにヘルパー関数やユーティリティを作成するな
- 仮想的な将来の要件のために設計するな。現在のタスクに必要な最小限の複雑さだけを実装せよ
- より単純なアプローチが存在する場合は、ユーザーに提案し、複雑な実装を押し戻せ (Push back)

### 1.3 思考の強制 (Think First)

- コーディング前に必ず計画を提示し、ユーザーの承認を得よ
- 自身の仮定を明示せよ
- 曖昧な点は推測せず、ユーザーに質問せよ
- 複数の解釈が可能な場合は、それらを列挙して確認を求めよ
- 不確実な技術的判断を単独で行うな

---

## 2. ワークフロー: PRAR サイクル (Perceive → Reason → Act → Refine)

すべてのタスクは以下のサイクルに従って実行せよ。

### 2.1 Perceive (認識)

- ユーザーのリクエストを分解し、明示的および暗黙的な要件を特定せよ
- 既存のコードベースと環境を調査し、関連するファイルやモジュールを把握せよ
- 曖昧さがあれば対話によって解消せよ

### 2.2 Reason (推論)

- 変更対象のファイルと影響範囲を特定せよ
- テスト戦略を策定せよ
- 実装前に「内部ドライラン（精神的シミュレーション）」を行い、潜在的なエラーや副作用を予測せよ
- なぜその技術・設計パターンを選択したのかを説明できるようにせよ

### 2.3 Act (実行)

- 承認された計画に基づき、小さな増分で実装を進めよ
- テスト駆動開発 (TDD) を原則とせよ: まずテストを書き、失敗を確認してから実装に移れ
- 変更のたびにテスト、リンター、型チェックを実行せよ

### 2.4 Refine (洗練)

- プロジェクト全体の検証を実行せよ
- 必要に応じてドキュメントを更新せよ
- 論理的で簡潔なコミットメッセージを作成せよ
- 今回のプロセスから得られた教訓を `LEARNINGS.md` に記録せよ

---

## 3. 技術スタック & 環境 (Tech Stack)

> **注意**: 以下はプロジェクトの成長に合わせて更新すること。

| カテゴリ | 技術 |
|---|---|
| 言語 | Python 3.12+ |
| パッケージマネージャ | uv (推奨) |
| テスト | pytest |
| リンター/フォーマッター | ruff |
| バージョン管理 | Git |

---

## 4. 実行可能なコマンド (Executable Commands)

AIエージェントは以下のコマンドを使用して変更を検証せよ。

```bash
# テスト実行
uv run pytest -v

# リンター実行
uv run ruff check .

# フォーマット確認
uv run ruff format --check .

# フォーマット適用
uv run ruff format .

# 型チェック (mypy 導入後)
uv run mypy .
```

---

## 5. 境界条件 (Boundaries)

### Always (常に実行せよ)

- すべての変更後にリンターとテストを実行せよ
- コミット前に diff を確認し、意図しない変更が含まれていないか検証せよ
- エラーハンドリングはシステム境界（ユーザー入力、外部API）でのみ行え

### Ask First (実行前にユーザーに確認せよ)

- データベーススキーマの変更
- 外部ライブラリやAPIの新規導入
- アーキテクチャに影響する設計変更
- 既存のパブリックAPIの変更

### Never (決してするな)

- `.env` ファイルや認証情報をコミットするな
- 本番環境へ直接プッシュするな
- 既存のパスしているテストを削除するな
- ユーザーの許可なく認証フローを変更するな
- `force push` を実行するな
- セキュリティ脆弱性を導入するな (SQLインジェクション、XSS、コマンドインジェクション等)

---

## 6. コミュニケーション規約

- 技術的な判断には必ず根拠を示せ（「なぜその技術を選択したのか」を説明せよ）
- 変更の影響範囲を明示せよ
- 不確実性がある場合は、その旨を正直に伝えよ
- 過度な装飾や絵文字は使用するな（ユーザーが明示的に要求した場合を除く）

---

## 7. ドキュメント構成

本プロジェクトのAI向けドキュメントは以下の3層構造で管理される。

| ファイル | 役割 | 更新頻度 |
|---|---|---|
| `master.md` (本文書) | AI全体への基本行動原理・ワークフロー・技術スタックの定義 | プロジェクト構成変更時 |
| `rules.md` | コーディング規約・テスト・セキュリティ等の詳細ルール | 規約変更時 |
| `LEARNINGS.md` | 過去の教訓・エラーと解決策・設計判断の記録 | 各タスク完了時 |

AIエージェントは作業開始前に、これら3つのファイルすべてを読み込むこと。
