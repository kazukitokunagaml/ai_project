name: CI Checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-instructions:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync AI Pointer Files
        id: sync_docs
        run: |
          # 1. 全ツール共通の指示テキスト
          POINTER=$(cat << 'EOF'
          # AI Master Instructions

          作業開始時に `.instructions` にある、`master.md` → `rules.md` → `LEARNINGS.md` の順で読み込むこと。
          `HANDOFF.md` が存在する場合は最優先で読むこと。
          EOF
          )

          # 2. 配信先のリスト
          TARGETS=(
              ".claude/claude.md"
              ".codex/agents.md"
              ".gemini/gemini.md"
              ".github/copilot-instructions.md"
          )

          # 3. ファイルの書き込み
          for dst in "${TARGETS[@]}"; do
              mkdir -p "$(dirname "$dst")"
              echo "$POINTER" > "$dst"
              git add "$dst"
          done

          # 4. 変更があればコミット
          if [ -n "$(git status --porcelain)" ]; then
              echo "Changes detected. Committing..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git commit -m "docs: Sync AI instruction pointers"
              git push
              echo "docs_synced=true" >> $GITHUB_OUTPUT
          else
              echo "No changes to sync."
              echo "docs_synced=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Notify on sync
        if: steps.sync_docs.outputs.docs_synced == 'true'
        run: echo "AI pointer files have been updated."
